# STM32 MCP Build Server

AIè‡ªåŠ¨ç¼–è¯‘ä¿®å¤ç³»ç»Ÿ - åŸºäº MCP (Model Context Protocol) çš„åŒServeræ¶æ„ STM32 å¼€å‘å¹³å°

## ğŸ¯ é¡¹ç›®ç›®æ ‡

æ„å»º **åŒMCPæ¶æ„**ï¼Œå®ç°å®Œæ•´çš„åµŒå…¥å¼å¼€å‘é—­ç¯ï¼š

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                         å®Œæ•´å¼€å‘æµç¨‹                                 â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  Agentä¿®æ”¹ä»£ç                                                       â”‚
â”‚      â†“                                                              â”‚
â”‚  1ï¸âƒ£ Build MCP ç¼–è¯‘ (stm32_build_server.py)                         â”‚
â”‚      â”œâ”€ è¿”å›ç»“æ„åŒ–é”™è¯¯ â†’ Agentè‡ªåŠ¨ä¿®å¤                              â”‚
â”‚      â””â”€ ç¼–è¯‘æˆåŠŸ â†’ è¾“å‡ºåˆ° out/ ç›®å½•                                 â”‚
â”‚      â†“                                                              â”‚
â”‚  2ï¸âƒ£ Flash MCP çƒ§å½• (stm32_flash_server.py) ğŸ†•                      â”‚
â”‚      â””â”€ å°†hexæ–‡ä»¶çƒ§å½•åˆ°MCU                                          â”‚
â”‚      â†“                                                              â”‚
â”‚  3ï¸âƒ£ MCUè¿è¡ŒéªŒè¯ (Agenté€šè¿‡ä¸²å£/è°ƒè¯•æ¥å£éªŒè¯) ğŸ†•                    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### å•MCP vs åŒMCP æ¶æ„å¯¹æ¯”

| æ¶æ„ | åŠŸèƒ½ | é€‚ç”¨åœºæ™¯ |
|------|------|----------|
| **å•MCP (Build)** | ä»…ç¼–è¯‘ï¼Œè¿”å›é”™è¯¯ | çº¯ç¼–è¯‘éªŒè¯ã€CI/CD |
| **åŒMCP (Build+Flash)** | ç¼–è¯‘+çƒ§å½•+è¿è¡ŒéªŒè¯ | å®Œæ•´å¼€å‘é—­ç¯ã€ç¡¬ä»¶åœ¨ç¯æµ‹è¯• |

## ğŸ—ï¸ åŒMCPç³»ç»Ÿæ¶æ„

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                        Agent (AI Assistant)                      â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”â”‚
â”‚  â”‚  å®Œæ•´å·¥ä½œæµç¨‹:                                              â”‚â”‚
â”‚  â”‚  1. ä¿®æ”¹ä»£ç  â†’ 2. Build MCPç¼–è¯‘ â†’ 3. è§£æé”™è¯¯ä¿®å¤          â”‚â”‚
â”‚  â”‚  â†’ 4. ç¼–è¯‘æˆåŠŸ â†’ 5. Flash MCPçƒ§å½• â†’ 6. MCUè¿è¡ŒéªŒè¯         â”‚â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
           â”‚                               â”‚
    â”Œâ”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”              â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚  Build MCP   â”‚              â”‚   Flash MCP      â”‚
    â”‚  (ç¼–è¯‘)      â”‚   äº§ç‰©ä¼ é€’   â”‚   (çƒ§å½•)         â”‚
    â”‚              â”‚â—„â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–ºâ”‚                  â”‚
    â”‚  build_      â”‚  (å…±äº«out/)  â”‚  flash_          â”‚
    â”‚  firmware()  â”‚              â”‚  firmware()      â”‚
    â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜              â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜
           â”‚                               â”‚
    â”Œâ”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”              â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚ Dockerç¼–è¯‘   â”‚              â”‚  çƒ§å½•å·¥å…·é“¾       â”‚
    â”‚ å®¹å™¨        â”‚              â”‚ (OpenOCD/        â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜              â”‚  ST-Link/J-Link) â”‚
           â”‚                     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
           â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                          â–¼
                 â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                 â”‚   STM32 MCU     â”‚
                 â”‚  (STM32F103CBTx)â”‚
                 â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### äº§ç‰©å…±äº«æœºåˆ¶

- **è¾“å‡ºç›®å½•**: `workspace/out/` (Build MCPå†™å…¥, Flash MCPè¯»å–)
- **äº§ç‰©æ ¼å¼**: 
  - `.hex` - Intel Hexæ ¼å¼ (çƒ§å½•ç”¨)
  - `.bin` - äºŒè¿›åˆ¶æ ¼å¼ (çƒ§å½•ç”¨)
  - `.elf` - ELFæ ¼å¼ (è°ƒè¯•ç”¨)
  - `build.log` - ç¼–è¯‘æ—¥å¿—

## ğŸ“ é¡¹ç›®ç»“æ„

```
STM32_Complier_MCP/
â”œâ”€â”€ docker/                      # Dockerç¼–è¯‘ç¯å¢ƒ
â”‚   â”œâ”€â”€ Dockerfile              # arm-none-eabi-gccå·¥å…·é“¾é•œåƒ
â”‚   â””â”€â”€ flash.Dockerfile        # ğŸ†• çƒ§å½•å·¥å…·é•œåƒ (OpenOCD/ST-Link)
â”œâ”€â”€ tools/                       # ç¼–è¯‘å·¥å…·è„šæœ¬
â”‚   â”œâ”€â”€ build.sh                # å®¹å™¨å†…ç¼–è¯‘å…¥å£è„šæœ¬
â”‚   â””â”€â”€ flash.sh                # ğŸ†• å®¹å™¨å†…çƒ§å½•å…¥å£è„šæœ¬
â”œâ”€â”€ mcp_build/                   # Build MCP Serveræ ¸å¿ƒä»£ç 
â”‚   â”œâ”€â”€ __init__.py
â”‚   â”œâ”€â”€ stm32_build_server.py   # Build MCPä¸»ç¨‹åº
â”‚   â””â”€â”€ gcc_parse.py            # GCC/LDé”™è¯¯è§£æå™¨
â”œâ”€â”€ mcp_flash/                   # ğŸ†• Flash MCP Serveræ ¸å¿ƒä»£ç 
â”‚   â”œâ”€â”€ __init__.py
â”‚   â””â”€â”€ stm32_flash_server.py   # Flash MCPä¸»ç¨‹åº
â”œâ”€â”€ out/                         # ğŸ†• å…±äº«è¾“å‡ºç›®å½• (ç¼–è¯‘äº§ç‰©)
â”œâ”€â”€ Requirement/                 # éœ€æ±‚æ–‡æ¡£
â”‚   â”œâ”€â”€ stm32_mcp_2in1.txt
â”‚   â”œâ”€â”€ stm32_mcp_gpt.txt
â”‚   â””â”€â”€ stm32_mcp_opus.txt
â”œâ”€â”€ Test_Data/                   # æµ‹è¯•å·¥ç¨‹
â”‚   â””â”€â”€ Elder_Lifter_STM32_V1.32/
â”œâ”€â”€ docs/                        # é¡¹ç›®æ–‡æ¡£
â”œâ”€â”€ scripts/                     # è¾…åŠ©è„šæœ¬
â”œâ”€â”€ tests/                       # å•å…ƒæµ‹è¯•
â”œâ”€â”€ .opencode/                   # ä¼šè¯è®°å¿†
â”œâ”€â”€ AGENTS.md                   # Agentè§„èŒƒ
â”œâ”€â”€ CHANGELOG.md                # ç‰ˆæœ¬å˜æ›´æ—¥å¿—
â”œâ”€â”€ README.md                   # é¡¹ç›®è¯´æ˜
â””â”€â”€ requirements.txt            # Pythonä¾èµ–
```

## ğŸš€ å¿«é€Ÿå¼€å§‹

### 1. æ„å»º Docker é•œåƒ

```bash
docker build -f docker/Dockerfile -t stm32-toolchain:latest .
```

### 2. éªŒè¯é•œåƒ

```bash
docker run --rm stm32-toolchain:latest arm-none-eabi-gcc --version
docker run --rm stm32-toolchain:latest make --version
```

### 3. å®‰è£…ä¾èµ–

```bash
pip install -r requirements.txt
```

### 4. å¯åŠ¨ MCP Server

```bash
# STDIO æ¨¡å¼
python -m mcp_build.stm32_build_server

# æˆ–ä½¿ç”¨ MCP Inspector è°ƒè¯•
uv run mcp dev mcp_build/stm32_build_server.py
```

### 5. Agent è°ƒç”¨ç¤ºä¾‹

```python
from agents import Agent
from agents.mcp import MCPServerStdio

async def main():
    async with MCPServerStdio(
        command="python",
        args=["-m", "mcp_build.stm32_build_server"],
        cwd="/path/to/your-project",
    ) as mcp_server:
        agent = Agent(
            name="STM32 Build Agent",
            instructions="...",
            mcp_servers=[mcp_server],
        )
        # ... agent å¾ªç¯ä¿®å¤é€»è¾‘
```

## ğŸ›¡ï¸ æ ¸å¿ƒåŸåˆ™

| åŸåˆ™ | è¯´æ˜ |
|------|------|
| **MCPåªç¼–è¯‘ï¼Œä¸æ”¹ä»£ç ** | æºç ä»¥åªè¯»æ–¹å¼æŒ‚è½½è¿›Dockerå®¹å™¨ (`:ro`) |
| **Agentåªæ”¹ä»£ç ï¼Œä¸ç›´æ¥ç¼–è¯‘** | æ‰€æœ‰ç¼–è¯‘åŠ¨ä½œéƒ½é€šè¿‡MCPå·¥å…·è°ƒç”¨ |
| **ç»“æ„åŒ–é”™è¯¯è¿”å›** | MCPè§£æGCCè¾“å‡ºï¼Œè¿”å›`file/line/col/message`ç»“æ„åŒ–æ•°æ® |
| **å¯é‡å¤æ„å»ºç¯å¢ƒ** | ä½¿ç”¨Dockerå®¹å™¨ä¿è¯ç¼–è¯‘ç¯å¢ƒä¸€è‡´æ€§ |

## ğŸ“‹ å¼€å‘é˜¶æ®µ

### Phase 1-3: Build MCP (ç¼–è¯‘)
- [x] **Phase 0**: é¡¹ç›®åˆå§‹åŒ–ä¸ä»“åº“æ­å»º
- [x] **Phase 1**: Dockerç¼–è¯‘ç¯å¢ƒ
  - [x] Dockerfile (arm-none-eabi-gcc)
  - [x] build.sh (å®¹å™¨å†…ç¼–è¯‘è„šæœ¬)
  - [x] æµ‹è¯•å·¥ç¨‹Makefile
- [ ] **Phase 2**: MCP Serveræ ¸å¿ƒ
  - [ ] stm32_build_server.py
  - [ ] build_firmwareå·¥å…·
  - [ ] å®‰å…¨æ ¡éªŒå’Œè¶…æ—¶æ§åˆ¶
- [ ] **Phase 3**: é”™è¯¯è§£æå™¨
  - [ ] gcc_parse.py
  - [ ] GCC/LDé”™è¯¯è§£æ
  - [ ] å®Œæ•´é—­ç¯æµ‹è¯•

### Phase 4-6: Flash MCP (çƒ§å½•) ğŸ†•
- [ ] **Phase 4**: Flash MCP Server
  - [ ] stm32_flash_server.py
  - [ ] flash_firmwareå·¥å…·
  - [ ] æ”¯æŒST-Link/OpenOCD/J-Link
- [ ] **Phase 5**: çƒ§å½•ç¯å¢ƒæ­å»º
  - [ ] flash.Dockerfile
  - [ ] USBè®¾å¤‡æƒé™é…ç½®
  - [ ] çƒ§å½•è„šæœ¬
- [ ] **Phase 6**: åŒMCPé›†æˆ
  - [ ] Build â†’ Flash äº§ç‰©ä¼ é€’
  - [ ] Agentåè°ƒä¸¤ä¸ªMCP
  - [ ] å®Œæ•´é—­ç¯æµ‹è¯•

## ğŸ”§ æŠ€æœ¯æ ˆ

- **Language**: Python 3.10+
- **MCP Framework**: FastMCP (mcp[cli]>=1.26.0)
- **Container**: Docker + Ubuntu 24.04
- **Toolchain**: arm-none-eabi-gcc (GNU Arm Embedded Toolchain)
- **Build System**: GNU Make
- **Target**: STM32F1xx ç³»åˆ— (Cortex-M3)

## ğŸ“ è®¸å¯è¯

MIT License

## ğŸ”— å‚è€ƒæ–‡æ¡£

- [MCPå®˜æ–¹è§„èŒƒ](https://modelcontextprotocol.io/)
- [MCP Python SDK](https://github.com/modelcontextprotocol/python-sdk)
- [Arm GNU Toolchain](https://developer.arm.com/Tools%20and%20Software/GNU%20Toolchain)
- [STM32CubeMXç”¨æˆ·æ‰‹å†Œ](https://www.st.com/resource/en/user_manual/um1718-stm32cubemx-for-stm32-configuration-and-initialization-code-generation-stmicroelectronics.pdf)
