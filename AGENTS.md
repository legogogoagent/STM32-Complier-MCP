# AGENTS.md - STM32 MCP Build Server

**Project**: STM32 MCP Build Server - AIè‡ªåŠ¨ç¼–è¯‘ä¿®å¤ç³»ç»Ÿ
**Purpose**: æ„å»ºMCP (Model Context Protocol) Build Serverï¼Œå®ç°"ä¿®æ”¹â†’ç¼–è¯‘â†’è§£æé”™è¯¯â†’è‡ªåŠ¨ä¿®å¤"é—­ç¯
**Tech Stack**: Python + FastMCP + Docker + arm-none-eabi-gcc

---

## é¡¹ç›®ç»“æ„

```
STM32_Complier_MCP/
â”œâ”€â”€ docker/                      # Dockerç¼–è¯‘ç¯å¢ƒ
â”‚   â”œâ”€â”€ Dockerfile              # arm-none-eabi-gccå·¥å…·é“¾é•œåƒ
â”‚   â””â”€â”€ flash.Dockerfile        # çƒ§å½•å·¥å…·é•œåƒ (OpenOCD/ST-Link)
â”œâ”€â”€ tools/                       # ç¼–è¯‘å·¥å…·è„šæœ¬
â”‚   â”œâ”€â”€ build.sh                # å®¹å™¨å†…ç¼–è¯‘å…¥å£è„šæœ¬
â”‚   â””â”€â”€ flash.sh                # å®¹å™¨å†…çƒ§å½•å…¥å£è„šæœ¬
â”œâ”€â”€ mcp_build/                   # Build MCP Serveræ ¸å¿ƒä»£ç 
â”‚   â”œâ”€â”€ __init__.py
â”‚   â”œâ”€â”€ stm32_build_server.py   # Build MCPä¸»ç¨‹åº
â”‚   â””â”€â”€ gcc_parse.py            # GCC/LDé”™è¯¯è§£æå™¨
â”œâ”€â”€ mcp_flash/                   # ğŸ†• Flash MCP Serveræ ¸å¿ƒä»£ç 
â”‚   â”œâ”€â”€ __init__.py
â”‚   â””â”€â”€ stm32_flash_server.py   # Flash MCPä¸»ç¨‹åº
â”œâ”€â”€ out/                         # ğŸ†• å…±äº«è¾“å‡ºç›®å½• (ç¼–è¯‘äº§ç‰©)
â”œâ”€â”€ Requirement/                 # éœ€æ±‚æ–‡æ¡£
â”‚   â”œâ”€â”€ stm32_mcp_2in1.txt
â”‚   â”œâ”€â”€ stm32_mcp_gpt.txt
â”‚   â””â”€â”€ stm32_mcp_opus.txt
â”œâ”€â”€ Test_Data/                   # æµ‹è¯•å·¥ç¨‹
â”‚   â””â”€â”€ Elder_Lifter_STM32_V1.32/
â”œâ”€â”€ docs/                        # é¡¹ç›®æ–‡æ¡£
â”œâ”€â”€ scripts/                     # è¾…åŠ©è„šæœ¬
â”œâ”€â”€ tests/                       # å•å…ƒæµ‹è¯•
â”œâ”€â”€ .opencode/                   # ä¼šè¯è®°å¿†
â”œâ”€â”€ AGENTS.md                   # æœ¬æ–‡ä»¶ - Agentè§„èŒƒ
â”œâ”€â”€ CHANGELOG.md                # ç‰ˆæœ¬å˜æ›´æ—¥å¿—
â”œâ”€â”€ README.md                   # é¡¹ç›®è¯´æ˜
â””â”€â”€ requirements.txt            # Pythonä¾èµ–
```

---

## ğŸ—ï¸ åŒMCPæ¶æ„è®¾è®¡

### æ¶æ„å›¾

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                        Agent (AI Assistant)                      â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”â”‚
â”‚  â”‚  å®Œæ•´å·¥ä½œæµç¨‹:                                              â”‚â”‚
â”‚  â”‚  1. ä¿®æ”¹ä»£ç  â†’ 2. Build MCPç¼–è¯‘ â†’ 3. è§£æé”™è¯¯ä¿®å¤          â”‚â”‚
â”‚  â”‚  â†’ 4. ç¼–è¯‘æˆåŠŸ â†’ 5. Flash MCPçƒ§å½• â†’ 6. MCUè¿è¡ŒéªŒè¯         â”‚â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
           â”‚                               â”‚
    â”Œâ”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”              â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚  Build MCP   â”‚              â”‚   Flash MCP      â”‚
    â”‚  (ç¼–è¯‘)      â”‚   äº§ç‰©ä¼ é€’   â”‚   (çƒ§å½•)         â”‚
    â”‚              â”‚â—„â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–ºâ”‚                  â”‚
    â”‚  build_      â”‚  (å…±äº«out/)  â”‚  flash_          â”‚
    â”‚  firmware()  â”‚              â”‚  firmware()      â”‚
    â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜              â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜
           â”‚                               â”‚
    â”Œâ”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”              â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚ Dockerç¼–è¯‘   â”‚              â”‚  çƒ§å½•å·¥å…·é“¾       â”‚
    â”‚ å®¹å™¨        â”‚              â”‚ (OpenOCD/        â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜              â”‚  ST-Link/J-Link) â”‚
           â”‚                     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
           â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                          â–¼
                 â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                 â”‚   STM32 MCU     â”‚
                 â”‚  (STM32F103CBTx)â”‚
                 â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### æ•°æ®æµè¯´æ˜

1. **Buildé˜¶æ®µ**: Agentä¿®æ”¹ä»£ç  â†’ Build MCPç¼–è¯‘ â†’ äº§ç‰©ä¿å­˜åˆ° `out/` ç›®å½•
2. **Flashé˜¶æ®µ**: ç¼–è¯‘æˆåŠŸå â†’ Flash MCPè¯»å– `out/*.hex` â†’ çƒ§å½•åˆ°MCU
3. **éªŒè¯é˜¶æ®µ**: çƒ§å½•å®Œæˆå â†’ AgentéªŒè¯MCUè¿è¡ŒçŠ¶æ€

### äº§ç‰©å…±äº«æœºåˆ¶

- **è¾“å‡ºç›®å½•**: `workspace/out/` (Build MCPå†™å…¥, Flash MCPè¯»å–)
- **äº§ç‰©æ ¼å¼**: 
  - `.hex` - Intel Hexæ ¼å¼ (çƒ§å½•ç”¨)
  - `.bin` - äºŒè¿›åˆ¶æ ¼å¼ (çƒ§å½•ç”¨)
  - `.elf` - ELFæ ¼å¼ (è°ƒè¯•ç”¨)
  - `build.log` - ç¼–è¯‘æ—¥å¿—

---

## AGENT ROLES

### @git-manager (Git åè°ƒå‘˜)

**èŒè´£**: ç®¡ç†é¡¹ç›®ç‰ˆæœ¬æ§åˆ¶ï¼Œç¡®ä¿ä»£ç å®‰å…¨

#### è‡ªåŠ¨è§¦å‘è¯ï¼ˆå¬åˆ°è¿™äº›ç«‹å³æ‰§è¡Œæäº¤æµç¨‹ï¼‰
- "å†™å®Œäº†"ã€"å®Œæˆäº†"ã€"okäº†"ã€"æå®šäº†" â†’ æ ‡å‡†æäº¤
- "ä¿å­˜ä¸€ä¸‹"ã€"æäº¤å§"ã€"commit" â†’ æ ‡å‡†æäº¤  
- "å¼ºåˆ¶æäº¤"ã€"ä¿å­˜æ£€æŸ¥ç‚¹"ã€"commit now" â†’ ç«‹å³æäº¤ï¼ˆä¸é—®ç¡®è®¤ï¼‰

#### å®šæ—¶æé†’
- ä¼šè¯å¼€å§‹30åˆ†é’Ÿåï¼Œå¦‚æœæ£€æµ‹åˆ°æœ‰æœªæäº¤çš„æ”¹åŠ¨ï¼š
  "â° å·²å·¥ä½œ30åˆ†é’Ÿï¼ŒæœŸé—´æ”¹åŠ¨äº†ï¼š[æ–‡ä»¶åˆ—è¡¨]ã€‚æ˜¯å¦æäº¤å½“å‰è¿›åº¦ï¼Ÿ"

#### è®°å¿†ç»´æŠ¤
ç»´æŠ¤ `.opencode/session.json`ï¼š
```json
{
  "session_id": "uuid",
  "start_time": "2026-02-11T10:00:00Z",
  "files_modified": [
    {
      "path": "mcp_build/stm32_build_server.py",
      "edit_count": 3,
      "last_modified": "2026-02-11T10:30:00Z",
      "context": "å®ç°build_firmwareå·¥å…·"
    }
  ],
  "commits": [
    {
      "hash": "abc123",
      "message": "feat: å®ç°Dockerç¼–è¯‘ç¯å¢ƒ",
      "time": "2026-02-11T10:15:00Z"
    }
  ]
}
```

---

### @build-master (æ„å»ºä¸“å®¶)

**èŒè´£**: è´Ÿè´£Dockerç¼–è¯‘ç¯å¢ƒå’ŒMakefileç”Ÿæˆ

#### æ ¸å¿ƒä»»åŠ¡
1. åˆ›å»º `docker/Dockerfile` - Ubuntu 24.04 + arm-none-eabi-gcc
2. åˆ›å»º `tools/build.sh` - å®¹å™¨å†…ç¼–è¯‘è„šæœ¬
3. ä¸ºæµ‹è¯•å·¥ç¨‹ç”Ÿæˆ `Makefile`
4. ç¡®ä¿ç¼–è¯‘ç¯å¢ƒå¯é‡å¤

#### éªŒæ”¶æ ‡å‡†
- Dockeré•œåƒæ„å»ºæˆåŠŸ (< 1GB)
- arm-none-eabi-gcc --version è¾“å‡ºæ­£ç¡®
- build.sh èƒ½åœ¨åªè¯» /src ä¸‹æ­£å¸¸å·¥ä½œ

---

### @mcp-developer (MCPå¼€å‘è€…)

**èŒè´£**: å®ç°MCP Build Serveræ ¸å¿ƒåŠŸèƒ½

#### æ ¸å¿ƒä»»åŠ¡
1. åˆ›å»º `mcp_build/stm32_build_server.py` - FastMCP Server
2. å®ç° `build_firmware` å·¥å…·
3. å®‰å…¨æ ¡éªŒå’Œè¶…æ—¶æ§åˆ¶
4. Dockeré›†æˆå’Œé”™è¯¯å¤„ç†

#### APIè§„èŒƒ
```python
@tool
def build_firmware(
    workspace: str,           # å·¥ç¨‹æ ¹ç›®å½•ç»å¯¹è·¯å¾„
    project_subdir: str = "",  # Makefileå­ç›®å½•
    clean: bool = True,       # æ˜¯å¦å…ˆmake clean
    jobs: int = 8,           # å¹¶è¡Œä»»åŠ¡æ•°
    make_target: str = "all", # makeç›®æ ‡
    timeout_sec: int = 600,   # è¶…æ—¶ç§’æ•°
    max_log_tail_kb: int = 96, # æ—¥å¿—å°¾éƒ¨å¤§å°
    image: str = ""          # è¦†ç›–é»˜è®¤é•œåƒ
) -> dict:
    """
    è¿”å›ç»“æ„:
    {
        "ok": bool,
        "exit_code": int,
        "image": str,
        "outdir": str,
        "artifacts": list[str],
        "errors": list[dict],
        "log_tail": str,
        "docker_tail": str
    }
    """
```

---

### @parser-engineer (è§£æå·¥ç¨‹å¸ˆ)

**èŒè´£**: å®ç°GCC/LDé”™è¯¯è§£æå™¨

#### æ ¸å¿ƒä»»åŠ¡
1. åˆ›å»º `mcp_build/gcc_parse.py`
2. è§£æç¼–è¯‘æœŸé”™è¯¯ï¼š`file:line:col: error: message`
3. è§£æé“¾æ¥æœŸé”™è¯¯ï¼š`undefined reference to`
4. è·¯å¾„å½’ä¸€åŒ–å’Œæ’åº

#### é”™è¯¯ç»“æ„
```python
{
    "type": "compiler" | "linker" | "toolchain" | "system",
    "severity": "error" | "warning" | "note",
    "file": "Core/Src/main.c",  # ç›¸å¯¹è·¯å¾„
    "line": 123,
    "col": 9,
    "message": "unknown type name 'Foo_t'",
    "raw": "åŸå§‹è¡Œæ–‡æœ¬"
}
```

---

### @flash-engineer (çƒ§å½•å·¥ç¨‹å¸ˆ) ğŸ†•

**èŒè´£**: å®ç°Flash MCP Serverï¼Œè´Ÿè´£å°†ç¼–è¯‘äº§ç‰©çƒ§å½•åˆ°MCU

#### æ ¸å¿ƒä»»åŠ¡
1. åˆ›å»º `mcp_flash/stm32_flash_server.py` - Flash MCP Server
2. å®ç° `flash_firmware` å·¥å…·
3. æ”¯æŒå¤šç§çƒ§å½•å™¨ (ST-Link, OpenOCD, J-Link)
4. USBè®¾å¤‡æƒé™ç®¡ç†

#### APIè§„èŒƒ
```python
@tool
def flash_firmware(
    workspace: str,           # å·¥ç¨‹æ ¹ç›®å½•ç»å¯¹è·¯å¾„
    hex_file: str = "",       # hexæ–‡ä»¶è·¯å¾„ï¼ˆç›¸å¯¹äºout/ï¼‰
    programmer: str = "stlink",  # çƒ§å½•å™¨ç±»å‹
    interface: str = "swd",   # æ¥å£ï¼šswd/jtag
    verify: bool = True,      # æ˜¯å¦éªŒè¯
    reset: bool = True,       # çƒ§å½•åå¤ä½
    timeout_sec: int = 120,   # è¶…æ—¶ç§’æ•°
) -> dict:
    """
    è¿”å›ç»“æ„:
    {
        "ok": bool,
        "exit_code": int,
        "programmer": str,
        "hex_file": str,
        "stdout": str,
        "stderr": str,
        "device_id": str  # MCUè®¾å¤‡ID
    }
    """
```

#### æ”¯æŒçš„çƒ§å½•å™¨
- **ST-Link/V2** - å®˜æ–¹çƒ§å½•å™¨ï¼Œé€Ÿåº¦å¿«
- **OpenOCD** - å¼€æºé€šç”¨ï¼Œæ”¯æŒå¤šç§è°ƒè¯•å™¨
- **J-Link** - å•†ä¸šçƒ§å½•å™¨ï¼ŒåŠŸèƒ½å¼ºå¤§
- **DAP-Link** - CMSIS-DAPæ ‡å‡†

---

## å¼€å‘æµç¨‹

### é˜¶æ®µ1: Dockerç¼–è¯‘ç¯å¢ƒ
1. åˆ›å»º `docker/Dockerfile`
2. åˆ›å»º `tools/build.sh`
3. ç”Ÿæˆæµ‹è¯•å·¥ç¨‹ `Makefile`
4. **éªŒæ”¶**: docker buildæˆåŠŸï¼Œèƒ½ç¼–è¯‘æµ‹è¯•å·¥ç¨‹

### é˜¶æ®µ2: MCP Serveræ ¸å¿ƒ
1. åˆ›å»º `mcp_build/stm32_build_server.py`
2. åˆ›å»º `mcp_build/__init__.py`
3. åˆ›å»º `requirements.txt`
4. **éªŒæ”¶**: MCP Inspectorèƒ½è°ƒç”¨ï¼Œè¿”å›ç¼–è¯‘ç»“æœ

### é˜¶æ®µ3: é”™è¯¯è§£æå™¨
1. åˆ›å»º `mcp_build/gcc_parse.py`
2. é›†æˆåˆ°MCP Server
3. å®Œæ•´é—­ç¯æµ‹è¯•
4. **éªŒæ”¶**: æ­£ç¡®è§£æGCC/LDé”™è¯¯

---

## ğŸ†• Flash MCP æ‰©å±• (Phase 2.5)

### é˜¶æ®µ2.5: Flash MCP Server ğŸ†•
1. åˆ›å»º `mcp_flash/stm32_flash_server.py`
2. åˆ›å»º `mcp_flash/__init__.py`
3. åˆ›å»º `docker/flash.Dockerfile` (çƒ§å½•å·¥å…·ç¯å¢ƒ)
4. **éªŒæ”¶**: èƒ½è¯»å–out/*.hexå¹¶çƒ§å½•åˆ°MCU

### é˜¶æ®µ3.5: åŒMCPé›†æˆæµ‹è¯• ğŸ†•
1. Build MCPç¼–è¯‘ â†’ è¾“å‡ºåˆ°out/
2. Flash MCPè¯»å– â†’ çƒ§å½•åˆ°MCU
3. éªŒè¯MCUè¿è¡ŒçŠ¶æ€
4. **éªŒæ”¶**: å®Œæ•´é—­ç¯ï¼ˆä¿®æ”¹â†’ç¼–è¯‘â†’çƒ§å½•â†’è¿è¡Œï¼‰

---

## æäº¤ä¿¡æ¯æ ¼å¼

```
<type>(<scope>): <subject>

<body>

<footer>
```

### Type
- `feat`: æ–°åŠŸèƒ½
- `fix`: ä¿®å¤bug
- `docs`: æ–‡æ¡£æ›´æ–°
- `style`: ä»£ç æ ¼å¼ï¼ˆä¸å½±å“åŠŸèƒ½ï¼‰
- `refactor`: é‡æ„
- `test`: æµ‹è¯•ç›¸å…³
- `chore`: æ„å»º/å·¥å…·

### Scope
- `docker`: Dockerç›¸å…³
- `mcp`: MCP Serverç›¸å…³
- `parser`: é”™è¯¯è§£æå™¨
- `tools`: å·¥å…·è„šæœ¬
- `test`: æµ‹è¯•ç›¸å…³
- `docs`: æ–‡æ¡£

### ç¤ºä¾‹
```
feat(docker): æ·»åŠ arm-none-eabi-gccç¼–è¯‘ç¯å¢ƒ

- åŸºäºUbuntu 24.04
- å®‰è£…gcc-arm-none-eabiå·¥å…·é“¾
- åˆ›å»º/workå’Œ/outç›®å½•

Closes #1
```

---

## å®‰å…¨è§„èŒƒ

### å¿…é¡»éµå®ˆ
1. **MCPåªç¼–è¯‘ï¼Œä¸æ”¹ä»£ç ** - workspaceä»¥åªè¯»(:ro)æŒ‚è½½
2. **Agentåªæ”¹ä»£ç ï¼Œä¸ç›´æ¥ç¼–è¯‘** - æ‰€æœ‰ç¼–è¯‘é€šè¿‡MCP
3. **å®¹å™¨ç¦ç½‘** - ä½¿ç”¨ `--network=none`
4. **è·¯å¾„ç™½åå•** - æ ¡éªŒ workspace åœ¨ `STM32_ALLOWED_ROOT` ä¸‹
5. **è¶…æ—¶æ§åˆ¶** - é˜²æ­¢ç¼–è¯‘å¡æ­»

### ç¦æ­¢æ“ä½œ
- âŒ åœ¨MCPä¸­ä¿®æ”¹workspaceä»»ä½•æ–‡ä»¶
- âŒ æ¥å—ç”¨æˆ·è‡ªå®šä¹‰shellå‘½ä»¤
- âŒ å®¹å™¨è®¿é—®ç½‘ç»œ
- âŒ ä¸åšè·¯å¾„æ ¡éªŒç›´æ¥æŒ‚è½½

---

## å‚è€ƒæ–‡æ¡£

- [MCPå®˜æ–¹è§„èŒƒ](https://modelcontextprotocol.io/)
- [MCP Python SDK](https://github.com/modelcontextprotocol/python-sdk)
- [Arm GNU Toolchain](https://developer.arm.com/Tools%20and%20Software/GNU%20Toolchain)
- [STM32CubeMXç”¨æˆ·æ‰‹å†Œ](https://www.st.com/resource/en/user_manual/um1718-stm32cubemx-for-stm32-configuration-and-initialization-code-generation-stmicroelectronics.pdf)

