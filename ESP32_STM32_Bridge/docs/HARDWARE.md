# 硬件连接指南

## 所需硬件

### ESP32开发板
- **推荐型号**: ESP32-WROOM-32 或 ESP32-WROVER
- **Flash**: 至少 4MB (用于存储固件缓冲)
- **PSRAM**: 可选 (8MB PSRAM可支持更大固件缓冲)

### STM32目标板
- 任何支持SWD接口的STM32 (F1/F4/F7/H7系列)
- 需要引出SWDIO、SWCLK、NRST引脚

### 连接线
- 杜邦线 (母对母或母对公，根据板子类型)
- 建议长度 < 20cm (减少干扰)

## 引脚连接

### 基本连接 (必需)

```
┌─────────────────┐         ┌─────────────────┐
│     ESP32       │         │     STM32       │
│                 │         │                 │
│  GPIO18         │────────▶│  SWDIO          │
│                 │         │                 │
│  GPIO19         │────────▶│  SWCLK          │
│                 │         │                 │
│  GND            │─────────│  GND            │
│                 │         │                 │
│  3.3V (可选)    │─────────│  3.3V (可选)    │
│                 │         │                 │
└─────────────────┘         └─────────────────┘
```

**注意**: 
- ESP32为3.3V逻辑电平，**不能直接连接5V**
- 如果STM32是5V供电，需要使用电平转换器或确保STM32 SWD引脚支持3.3V

### 可选连接

#### 复位控制
```
ESP32 GPIO21 ────────▶ STM32 NRST
```
连接NRST可实现软件复位STM32。

#### 串口透传 (调试用)
```
ESP32 GPIO16 (RX) ◀──────── STM32 UART_TX
ESP32 GPIO17 (TX) ────────▶ STM32 UART_RX
```
可将STM32的串口日志通过WiFi转发到PC。

## 完整接线图

```
                    ESP32开发板
                    ┌─────────┐
           3.3V ────┤EN       │
           GPIO23 ──┤VP       │
           GPIO22 ──┤VN       │
           GPIO1  ──┤D34      │
           GPIO3  ──┤D35      │
           GPIO21 ──┤D32      │──▶ NRST (可选)
           GPIO19 ──┤D33      │──▶ SWCLK
           GPIO18 ──┤D25      │──▶ SWDIO
           GPIO5  ──┤D26      │
           GPIO17 ──┤D27      │──▶ UART RX (可选)
           GPIO16 ──┤D14      │◀── UART TX (可选)
           GPIO4  ──┤D12      │
           GPIO2  ──┤D13      │
           GPIO15 ──┤D9       │
           GPIO13 ──┤D10      │
           GPIO12 ──┤D11      │
                  ──┤VDD 3.3V │──▶ 3.3V
                  ──┤D23      │
                  ──┤D22      │
                  ──┤TX0      │
                  ──┤RX0      │
                  ──┤D21      │
                  ──┤D19      │
                  ──┤D18      │
                  ──┤D5       │
                  ──┤D17      │
                  ──┤D16      │
                  ──┤D4       │
                  ──┤D0       │
                  ──┤D2       │
                  ──┤D15      │
                  ──┤D13      │
           GND  ────┤D12      │
                  ──┤D14      │
                  ──┤D27      │
                  ──┤D25      │
                  ──┤D26      │
                  ──┤D33      │
                  ──┤D32      │
                  ──┤D35      │
                  ──┤D34      │
                  ──┤VN       │
                  ──┤VP       │
           GND  ────┤EN       │
                    └─────────┘
                      │││
                      ││└──── GND
                      │└───── 3.3V
                      └────── USB
```

## 实物照片参考

```
        ┌─────────────────┐
        │   ESP32-WROOM   │
        │  ┌───────────┐  │
        │  │  Antenna  │  │
        │  └───────────┘  │
        │                 │
        │  [ ]      [ ]   │  USB
        │  [ ]      [ ]   │  (连接到PC供电/调试)
        │  [ ]      [ ]   │
        │                 │
        │  GPIO18  GPIO19 │──┬──┬── SWDIO/SWCLK
        │     │      │    │  │  │
        └─────┼──────┼────┘  │  │
              │      │       │  │
              │      │    ┌──┴──┴──┐
              ▼      ▼    │  STM32  │
            SWDIO   SWCLK │  Mini   │
                        │  Board  │
                        │  [LED]  │
                        └─────────┘
```

## 电源选项

### 选项1: USB供电 (推荐)
- ESP32通过USB供电
- STM32通过ESP32的3.3V供电 (如果电流足够)
- **注意**: ESP32的3.3V稳压器输出能力有限 (~500mA)

### 选项2: 独立供电
- ESP32: USB供电
- STM32: 独立3.3V电源或ST-Link供电
- **必须共地**: ESP32和STM32的GND必须连接在一起

### 选项3: 目标板供电
- 如果STM32板子有USB或外部电源
- ESP32可从STM32的3.3V获取电源 (如果电流足够)
- 同样需要共地

## 故障排除

### 无法读取IDCODE
1. 检查SWDIO/SWCLK连接是否正确
2. 检查GND是否连接
3. 确认STM32已上电
4. 尝试降低SWD时钟速度 (修改代码中的delay)
5. 检查是否有其他调试器占用了SWD接口

### 烧录失败
1. 确认固件格式为纯二进制 (.bin文件)
2. 检查固件大小是否在ESP32内存范围内
3. 确认STM32的Flash写保护已解除
4. 检查目标地址是否正确

### WiFi连接问题
1. AP模式: 确认PC/手机连接到`ESP32-STM32-Bridge`热点
2. STA模式: 确认WiFi凭据正确，ESP32和PC在同一网络
3. 检查防火墙是否阻挡了4444端口

## 安全提示

⚠️ **重要**:
- 不要在STM32运行时插拔SWD线 (可能导致损坏)
- 确保电压匹配 (ESP32为3.3V，5V会损坏ESP32)
- 不要短路任何引脚
- 使用ESD防护措施 (尤其在干燥环境)

## 扩展：多目标支持

如需同时连接多个STM32，可使用多路复用器或扩展板：

```
ESP32 ──▶ 多路复用器 ──┬──▶ STM32 #1
                    ├──▶ STM32 #2
                    └──▶ STM32 #3
```

多路复用器可使用CD4053等模拟开关实现。
